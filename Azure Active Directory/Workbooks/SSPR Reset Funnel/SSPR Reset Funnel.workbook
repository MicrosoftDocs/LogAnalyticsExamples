{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Self-service Password Reset Funnel and Troubleshooting"
      },
      "name": "Title",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "51539750-6bc8-4a60-a05d-cdf9d40f7a5d",
            "version": "KqlParameterItem/1.0",
            "name": "Date",
            "type": 4,
            "description": "Select the date range",
            "isRequired": true,
            "value": {
              "durationMs": 2592000000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            }
          },
          {
            "id": "03bb225a-19e0-4fb2-b38e-c79ea6c928e2",
            "version": "KqlParameterItem/1.0",
            "name": "Users",
            "label": "User Name",
            "type": 1,
            "description": "Enter the UPN (xxxx@domain.com) to filter the reset info for a specific user. Default value is \"All\"",
            "isRequired": true,
            "query": "print \"All\"",
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "Date",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 2"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let data = AuditLogs\r\n|where LoggedByService contains \"password\" \r\n|where ActivityDisplayName contains \"Self-service password reset flow activity progress\" or ActivityDisplayName contains \"Blocked from self-service password reset\" or ActivityDisplayName contains \"Unlock a user account (self-service)\"\r\n|extend User = TargetResources[0].userPrincipalName\r\n| where \"{Users:escape}\" == \"All\" or User contains \"{Users:escape}\"\r\n|project TimeGenerated, User, ActivityDisplayName, ResultReason\r\n|extend ResetStatus = case(ActivityDisplayName contains \"Unlock a user account (self-service)\", \"Unlock account\",ActivityDisplayName contains \"Reset password (self-service)\", \"Success\",\r\nResultReason contains \"User successfully reset password\", \"Success\",\r\nResultReason contains \"User successfully unlocked the account\", \"Success\",\r\nResultReason contains \"User cancelled before passing the required authentication methods\", \"Cancelled\",\r\nResultReason contains \"User cancelled before submitting a new password\", \"Cancelled\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"User's password is managed on-premises. You can enable Password Writeback to resolve this\", \"Failed\", \r\nResultReason contains \"User does not have a license. You can add a license to the user to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset is not enabled for this user. Enable password reset under the configure tab to resolve this\", \"Failed\",\r\nResultReason contains \"User's account has insufficient authentication methods defined. Add authentication info to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset has been disabled entirely for this tenant. See http://aka.ms/ssprtroubleshoot to resolve this.\", \"Failed\",\r\nResultReason contains \"This user is not a member of the password reset users group. Add this user to that group to resolve this.\", \"Failed\",\r\nResultReason contains \"User tried to reset from a device without cookies enabled\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the requirements of the AD on-prem policy\", \"Failed\",\r\nResultReason contains \"The user selected a password that was automatically banned because the Microsoft Banned Password Detection capabilities found it to be too common or especially weak.\",\"Failed\",\r\nResultReason contains \"A system error occurred while attempting to reset the user's password\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the security requirements of the cloud password policy: password was null or empty\",\"Failed\",\r\nResultReason contains \"User entered too many invalid SMS verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User entered too many invalid email verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried mobile phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried office phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to answer security questions too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to verify a phone number too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried email verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User submitted their user ID\", \"Initiated reset\",\r\nResultReason contains \"User submitted a new password\", \"Submitted Password\",\r\nResultReason contains \"User contacted an admin after trying the security question verification option\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\",\"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nActivityDisplayName contains \"Blocked from self-service password reset\", \"Blocked\",\r\nResultReason contains \"User completed all verification steps required to reset their password\", \"All gates verified\",\r\nResultReason contains \"User completed the email verification option\", \"Email gate verified\", \r\nResultReason contains \"User started the email verification option\", \"Email gate started\", \r\nResultReason contains \"User completed the mobile SMS verification option\", \"SMS gate verified\",\r\nResultReason contains \"User started the mobile SMS verification option\", \"SMS gate started\",\r\nResultReason contains \"User completed the mobile voice call verification option\", \"Mobile call gate verified\",\r\nResultReason contains \"User started the mobile voice call verification option\", \"Mobile call gate started\",ResultReason contains \"User completed the mobile app\", \"Mobile app gate verified\",\r\nResultReason contains \"User started the mobile app\", \"Mobile app notification gate started\",\r\nResultReason contains \"User completed the security questions verification option\", \"Security questions gate verified\",\r\nResultReason contains \"User started the security questions verification option\", \"Security questions gate started\",\r\nResultReason contains \"User was presented with verification options\", \"Started Gate verification\",\r\n\"Other\")\r\n|extend Stage = case(ResetStatus contains \" verified\", \"Inprogress\",\r\nResultReason contains \"User submitted their user ID\", \"Inprogress\",\r\nResetStatus contains \"Initiated\", \"Inprogress\",\r\nResetStatus contains \"started Gate\", \"Inprogress\",\r\nResetStatus contains \"Gate started\", \"Inprogress\",\r\nResetStatus contains \"contacted admin\", \"Inprogress\",\r\nResetStatus contains \"submitted password\", \"Inprogress\",\r\nResetStatus);\r\ndata\r\n| summarize Count = count() by Stage\r\n| project Stage, Count = iff(Stage == '', 0, Count)\r\n| join kind = inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated from {Date:start} to {Date:end} step {Date:grain} by Stage)\r\n    on Stage\r\n| project-away TimeGenerated\r\n| order by Count desc",
        "size": 3,
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "Date",
        "exportToExcelOptions": "visible",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Stage",
            "formatter": 1,
            "formatOptions": {
              "showIcon": true
            }
          },
          "leftContent": {
            "columnMatch": "Count",
            "formatter": 12,
            "formatOptions": {
              "palette": "turquoise",
              "showIcon": true
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "maximumFractionDigits": 2,
                "maximumSignificantDigits": 3
              }
            }
          },
          "secondaryContent": {
            "columnMatch": "Trend",
            "formatter": 21,
            "formatOptions": {
              "palette": "grayBlue",
              "showIcon": true
            }
          },
          "showBorder": false
        },
        "graphSettings": {
          "type": 0
        }
      },
      "name": "query - 4"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let data =AuditLogs\r\n|where LoggedByService contains \"password\" \r\n|where ActivityDisplayName contains \"Self-service password reset flow activity progress\" or ActivityDisplayName contains \"Blocked from self-service password reset\" or ActivityDisplayName contains \"Unlock a user account (self-service)\"\r\n|extend User = TargetResources[0].userPrincipalName\r\n| where \"{Users:escape}\" == \"All\" or User contains \"{Users:escape}\"\r\n|project TimeGenerated, User, ActivityDisplayName, ResultReason\r\n|extend ResetStatus = case(ActivityDisplayName contains \"Unlock a user account (self-service)\", \"Unlock account\",ActivityDisplayName contains \"Reset password (self-service)\", \"Success\",\r\nResultReason contains \"User successfully reset password\", \"Success\",\r\nResultReason contains \"User successfully unlocked the account\", \"Success\",\r\nResultReason contains \"User cancelled before passing the required authentication methods\", \"Cancelled\",\r\nResultReason contains \"User cancelled before submitting a new password\", \"Cancelled\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"User's password is managed on-premises. You can enable Password Writeback to resolve this\", \"Failed\", \r\nResultReason contains \"User does not have a license. You can add a license to the user to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset is not enabled for this user. Enable password reset under the configure tab to resolve this\", \"Failed\",\r\nResultReason contains \"User's account has insufficient authentication methods defined. Add authentication info to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset has been disabled entirely for this tenant. See http://aka.ms/ssprtroubleshoot to resolve this.\", \"Failed\",\r\nResultReason contains \"This user is not a member of the password reset users group. Add this user to that group to resolve this.\", \"Failed\",\r\nResultReason contains \"User tried to reset from a device without cookies enabled\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the requirements of the AD on-prem policy\", \"Failed\",\r\nResultReason contains \"The user selected a password that was automatically banned because the Microsoft Banned Password Detection capabilities found it to be too common or especially weak.\",\"Failed\",\r\nResultReason contains \"A system error occurred while attempting to reset the user's password\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the security requirements of the cloud password policy: password was null or empty\",\"Failed\",\r\nResultReason contains \"User entered too many invalid SMS verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User entered too many invalid email verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried mobile phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried office phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to answer security questions too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to verify a phone number too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried email verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User submitted their user ID\", \"Initiated reset\",\r\nResultReason contains \"User submitted a new password\", \"Submitted Password\",\r\nResultReason contains \"User contacted an admin after trying the security question verification option\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\",\"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nActivityDisplayName contains \"Blocked from self-service password reset\", \"Blocked\",\r\nResultReason contains \"User completed all verification steps required to reset their password\", \"All gates verified\",\r\nResultReason contains \"User completed the email verification option\", \"Email gate verified\", \r\nResultReason contains \"User started the email verification option\", \"Email gate started\", \r\nResultReason contains \"User completed the mobile SMS verification option\", \"SMS gate verified\",\r\nResultReason contains \"User started the mobile SMS verification option\", \"SMS gate started\",\r\nResultReason contains \"User completed the mobile voice call verification option\", \"Mobile call gate verified\",\r\nResultReason contains \"User started the mobile voice call verification option\", \"Mobile call gate started\",ResultReason contains \"User completed the mobile app\", \"Mobile app gate verified\",\r\nResultReason contains \"User started the mobile app\", \"Mobile app notification gate started\",\r\nResultReason contains \"User completed the security questions verification option\", \"Security questions gate verified\",\r\nResultReason contains \"User started the security questions verification option\", \"Security questions gate started\",\r\nResultReason contains \"User was presented with verification options\", \"Started Gate verification\",\r\n\"Other\")\r\n|extend Stage = case(ResetStatus contains \" verified\", \"Inprogress (Gate Verification)\",\r\nResultReason contains \"User submitted their user ID\", \"Inprogress (Initiated Reset)\",\r\nResetStatus contains \"Initiated\", \"Inprogress (Initiated Reset)\",\r\nResetStatus contains \"started Gate\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"Gate started\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"contacted admin\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"submitted password\", \"Inprogress (Submit password)\",\r\nResetStatus)\r\n|project TimeGenerated, Stage, ResetStatus;\r\nlet caData = data\r\n|summarize Count = count() by Stage\r\n| order by Count desc\r\n| project Stage, Count\r\n| extend Id = Stage;\r\ndata\r\n|summarize ResetDate = min(TimeGenerated), Count = count() by Stage, ResetStatus\r\n| order by ResetDate asc\r\n| project ResetDate, Stage, ResetStatus, Count\r\n| serialize Id = strcat(Stage, '/', ResetStatus)\r\n| join kind=inner\r\n(\r\n    caData\r\n)\r\non Stage\r\n| project Id, Name = ResetStatus, Type ='Action', ['Reset Flow Count'] = Count, ParentId = Id1, Stage, ResetDate\r\n| union \r\n(\r\ncaData\r\n| project Id,Name = Stage, Type ='Action', ['Reset Flow Count'] = Count, ParentId = '')\r\n|order by ['Reset Flow Count'] desc, ResetDate asc\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
        "size": 3,
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "Date",
        "exportFieldName": "",
        "exportParameterName": "StageInfo",
        "exportDefaultValue": "{ \"Name\":\"\", \"Type\":\"*\"}",
        "exportToExcelOptions": "visible",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Id",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Name",
              "formatter": 0,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Type",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Count",
              "formatter": 20,
              "formatOptions": {
                "palette": "turquoise",
                "showIcon": true
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "style": "decimal"
                }
              }
            },
            {
              "columnMatch": "ParentId",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Stage",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true,
                "aggregation": "Sum"
              }
            },
            {
              "columnMatch": "ResetDate",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "ResetStatus",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            }
          ],
          "rowLimit": 50,
          "hierarchySettings": {
            "idColumn": "Id",
            "parentColumn": "ParentId",
            "treeType": 0,
            "expanderColumn": "Name",
            "expandTopLevel": false
          },
          "labelSettings": [
            {
              "columnId": "Id",
              "label": "Id"
            },
            {
              "columnId": "Name",
              "label": "Name"
            },
            {
              "columnId": "Type",
              "label": "Type"
            },
            {
              "columnId": "Reset Flow Count",
              "label": "Reset Flow Count"
            },
            {
              "columnId": "ParentId",
              "label": "ParentId"
            },
            {
              "columnId": "Stage",
              "label": "Stage"
            },
            {
              "columnId": "ResetDate",
              "label": "ResetDate"
            }
          ]
        },
        "tileSettings": {
          "titleContent": {
            "columnMatch": "ResetStatus",
            "formatter": 1,
            "formatOptions": {
              "showIcon": true
            }
          },
          "subtitleContent": {
            "columnMatch": "Stage",
            "formatOptions": {
              "showIcon": true
            }
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "coldHot",
              "showIcon": true
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": true,
                "minimumIntegerDigits": 1,
                "maximumSignificantDigits": 3
              }
            }
          },
          "showBorder": false
        }
      },
      "name": "query - 3"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let details = dynamic({StageInfo});\r\nAuditLogs\r\n|where LoggedByService contains \"password\" \r\n|where ActivityDisplayName contains \"Self-service password reset flow activity progress\" or ActivityDisplayName contains \"Blocked from self-service password reset\" or ActivityDisplayName contains \"Unlock a user account (self-service)\"\r\n|extend User = tostring(TargetResources[0].userPrincipalName)\r\n| where \"{Users:escape}\" == \"All\" or User contains \"{Users:escape}\"\r\n|project TimeGenerated, User, ActivityDisplayName, ResultReason\r\n|extend ResetStatus = case(ActivityDisplayName contains \"Unlock a user account (self-service)\", \"Unlock account\",ActivityDisplayName contains \"Reset password (self-service)\", \"Success\",\r\nResultReason contains \"User successfully reset password\", \"Success\",\r\nResultReason contains \"User successfully unlocked the account\", \"Success\",\r\nResultReason contains \"User cancelled before passing the required authentication methods\", \"Cancelled\",\r\nResultReason contains \"User cancelled before submitting a new password\", \"Cancelled\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"User's password is managed on-premises. You can enable Password Writeback to resolve this\", \"Failed\", \r\nResultReason contains \"User does not have a license. You can add a license to the user to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset is not enabled for this user. Enable password reset under the configure tab to resolve this\", \"Failed\",\r\nResultReason contains \"User's account has insufficient authentication methods defined. Add authentication info to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset has been disabled entirely for this tenant. See http://aka.ms/ssprtroubleshoot to resolve this.\", \"Failed\",\r\nResultReason contains \"This user is not a member of the password reset users group. Add this user to that group to resolve this.\", \"Failed\",\r\nResultReason contains \"User tried to reset from a device without cookies enabled\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the requirements of the AD on-prem policy\", \"Failed\",\r\nResultReason contains \"The user selected a password that was automatically banned because the Microsoft Banned Password Detection capabilities found it to be too common or especially weak.\",\"Failed\",\r\nResultReason contains \"A system error occurred while attempting to reset the user's password\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the security requirements of the cloud password policy: password was null or empty\",\"Failed\",\r\nResultReason contains \"User entered too many invalid SMS verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User entered too many invalid email verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried mobile phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried office phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to answer security questions too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to verify a phone number too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried email verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User submitted their user ID\", \"Initiated reset\",\r\nResultReason contains \"User submitted a new password\", \"Submitted Password\",\r\nResultReason contains \"User contacted an admin after trying the security question verification option\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\",\"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nActivityDisplayName contains \"Blocked from self-service password reset\", \"Blocked\",\r\nResultReason contains \"User completed all verification steps required to reset their password\", \"All gates verified\",\r\nResultReason contains \"User completed the email verification option\", \"Email gate verified\", \r\nResultReason contains \"User started the email verification option\", \"Email gate started\", \r\nResultReason contains \"User completed the mobile SMS verification option\", \"SMS gate verified\",\r\nResultReason contains \"User started the mobile SMS verification option\", \"SMS gate started\",\r\nResultReason contains \"User completed the mobile voice call verification option\", \"Mobile call gate verified\",\r\nResultReason contains \"User started the mobile voice call verification option\", \"Mobile call gate started\",ResultReason contains \"User completed the mobile app\", \"Mobile app gate verified\",\r\nResultReason contains \"User started the mobile app\", \"Mobile app notification gate started\",\r\nResultReason contains \"User completed the security questions verification option\", \"Security questions gate verified\",\r\nResultReason contains \"User started the security questions verification option\", \"Security questions gate started\",\r\nResultReason contains \"User was presented with verification options\", \"Started Gate verification\",\r\n\"Other\")\r\n|extend Stage = case(ResetStatus contains \" verified\", \"Inprogress (Gate Verification)\",\r\nResultReason contains \"User submitted their user ID\", \"Inprogress (Initiated Reset)\",\r\nResetStatus contains \"Initiated\", \"Inprogress (Initiated Reset)\",\r\nResetStatus contains \"started Gate\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"Gate started\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"contacted admin\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"submitted password\", \"Inprogress (Submit password)\",\r\nResetStatus)\r\n| where details.Type == '*' or (details.Type == 'Action' and Stage == details.Name) or (details.Type == 'Action' and Stage == details.ParentId and ResetStatus == details.Name)\r\n|summarize TotalCount = count(), SuccessCount = countif(ResetStatus == \"Success\"), FailureCount = countif(ResetStatus == \"Failed\"), CancelledCount = countif(ResetStatus == \"Cancelled\"),ThrottledCount = countif(ResetStatus == \"Throttled\"), BlockedCount = countif(ResetStatus == \"Blocked\"),InProgressCount = countif(Stage contains \"Inprogress\") by User\r\n| order by TotalCount desc, User asc\r\n| extend Id = User\r\n| project Id, Name = User, Type = 'User', ['Inprogress'] = InProgressCount,['Success'] = SuccessCount,['Failed'] = FailureCount,  ['Cancelled'] = CancelledCount,['Blocked'] = BlockedCount,['Throttled'] = ThrottledCount\r\n| order by Name asc\r\n\r\n",
        "size": 3,
        "title": "User List & Reset Status Count",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "Date",
        "exportFieldName": "Name",
        "exportParameterName": "UserName",
        "exportDefaultValue": "*",
        "exportToExcelOptions": "all",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Id",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Name",
              "formatter": 0,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Type",
              "formatter": 0,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Inprogress",
              "formatter": 4,
              "formatOptions": {
                "palette": "yellow",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Success",
              "formatter": 4,
              "formatOptions": {
                "palette": "green",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Failed",
              "formatter": 4,
              "formatOptions": {
                "palette": "redBright",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Cancelled",
              "formatter": 4,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Blocked",
              "formatter": 4,
              "formatOptions": {
                "palette": "redBright",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Throttled",
              "formatter": 4,
              "formatOptions": {
                "palette": "redBright",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Reset Flow Count",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            }
          ],
          "rowLimit": 50,
          "filter": true,
          "labelSettings": [
            {
              "columnId": "Id",
              "label": "Id"
            },
            {
              "columnId": "Name",
              "label": "Name"
            },
            {
              "columnId": "Type",
              "label": "Type"
            },
            {
              "columnId": "Inprogress",
              "label": "Inprogress"
            },
            {
              "columnId": "Success",
              "label": "Success"
            },
            {
              "columnId": "Failed",
              "label": "Failed"
            },
            {
              "columnId": "Cancelled",
              "label": "Cancelled"
            },
            {
              "columnId": "Blocked",
              "label": "Blocked"
            },
            {
              "columnId": "Throttled",
              "label": "Throttled"
            }
          ]
        }
      },
      "name": "query - 5",
      "styleSettings": {
        "progressStyle": "squares"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "//let details = dynamic({StageInfo});\r\nlet data = AuditLogs\r\n|where LoggedByService contains \"password\" \r\n|where ActivityDisplayName contains \"Self-service password reset flow activity progress\" or ActivityDisplayName contains \"Blocked from self-service password reset\" or ActivityDisplayName contains \"Unlock a user account (self-service)\"\r\n|extend User = tostring(TargetResources[0].userPrincipalName)\r\n//|where User in ({Users}) or '*' in ({Users})\r\n| where \"{Users:escape}\" == \"All\" or User contains \"{Users:escape}\"\r\n| where '{UserName}' == User\r\n|extend IPAddress = tostring(InitiatedBy.user.ipAddress)\r\n|extend UserId = tostring(InitiatedBy.user.id)\r\n|extend ResetStatus = case(ActivityDisplayName contains \"Unlock a user account (self-service)\", \"Unlock account\",ActivityDisplayName contains \"Reset password (self-service)\", \"Success\",\r\nResultReason contains \"User successfully reset password\", \"Success\",\r\nResultReason contains \"User successfully unlocked the account\", \"Success\",\r\nResultReason contains \"User cancelled before passing the required authentication methods\", \"Cancelled\",\r\nResultReason contains \"User cancelled before submitting a new password\", \"Cancelled\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We encountered a problem while resetting the user's on-premises password. Check your sync machine's event log\", \"Failed\",\r\nResultReason contains \"We could not reach your on-premises password reset service. Check your sync machine's event log\", \"Failed\", \r\nResultReason contains \"User's password is managed on-premises. You can enable Password Writeback to resolve this\", \"Failed\", \r\nResultReason contains \"User does not have a license. You can add a license to the user to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset is not enabled for this user. Enable password reset under the configure tab to resolve this\", \"Failed\",\r\nResultReason contains \"User's account has insufficient authentication methods defined. Add authentication info to resolve this\", \"Failed\",\r\nResultReason contains \"Password reset has been disabled entirely for this tenant. See http://aka.ms/ssprtroubleshoot to resolve this.\", \"Failed\",\r\nResultReason contains \"This user is not a member of the password reset users group. Add this user to that group to resolve this.\", \"Failed\",\r\nResultReason contains \"User tried to reset from a device without cookies enabled\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the requirements of the AD on-prem policy\", \"Failed\",\r\nResultReason contains \"The user selected a password that was automatically banned because the Microsoft Banned Password Detection capabilities found it to be too common or especially weak.\",\"Failed\",\r\nResultReason contains \"A system error occurred while attempting to reset the user's password\", \"Failed\",\r\nResultReason contains \"User submitted a password that did not meet the security requirements of the cloud password policy: password was null or empty\",\"Failed\",\r\nResultReason contains \"User entered too many invalid SMS verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User entered too many invalid email verification codes and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried mobile phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried office phone voice verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to answer security questions too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried to verify a phone number too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User tried email verification too many times and is blocked for 24 hours\", \"Throttled\",\r\nResultReason contains \"User submitted their user ID\", \"Initiated reset\",\r\nResultReason contains \"User submitted a new password\", \"Submitted Password\",\r\nResultReason contains \"User contacted an admin after trying the security question verification option\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\",\"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nResultReason contains \"User contacted an admin\", \"Contacted Admin\",\r\nActivityDisplayName contains \"Blocked from self-service password reset\", \"Blocked\",\r\nResultReason contains \"User completed all verification steps required to reset their password\", \"All gates verified\",\r\nResultReason contains \"User completed the email verification option\", \"Email gate verified\", \r\nResultReason contains \"User started the email verification option\", \"Email gate started\", \r\nResultReason contains \"User completed the mobile SMS verification option\", \"SMS gate verified\",\r\nResultReason contains \"User started the mobile SMS verification option\", \"SMS gate started\",\r\nResultReason contains \"User completed the mobile voice call verification option\", \"Mobile call gate verified\",\r\nResultReason contains \"User started the mobile voice call verification option\", \"Mobile call gate started\",ResultReason contains \"User completed the mobile app\", \"Mobile app gate verified\",\r\nResultReason contains \"User started the mobile app\", \"Mobile app notification gate started\",\r\nResultReason contains \"User completed the security questions verification option\", \"Security questions gate verified\",\r\nResultReason contains \"User started the security questions verification option\", \"Security questions gate started\",\r\nResultReason contains \"User was presented with verification options\", \"Started Gate verification\",\r\n\"Other\")\r\n|extend Stage = case(ResetStatus contains \" verified\", \"Inprogress (Gate Verification)\",\r\nResultReason contains \"User submitted their user ID\", \"Inprogress (Initiated Reset)\",\r\nResetStatus contains \"Initiated\", \"Inprogress (Initiated Reset)\",\r\nResetStatus contains \"started Gate\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"Gate started\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"contacted admin\", \"Inprogress (Gate Verification)\",\r\nResetStatus contains \"submitted password\", \"Inprogress (Submit password)\",\r\nResetStatus)\r\n//| where details.Type == '*' or (details.Type == 'Action' and Stage == details.Name) or (details.Type == 'Action' and Stage == details.ParentId and ResetStatus == details.Name)\r\n|project TimeGenerated, CorrelationId, User, UserId, IPAddress, Stage, ResetStatus,ResultReason, Result\r\n|order by TimeGenerated asc;\r\nlet caData = data\r\n|summarize TotalCount = count() by User\r\n| order by TotalCount desc, User asc\r\n| project User, TotalCount\r\n| extend Id = User;\r\ndata\r\n//| where details.Type == '*' or (details.Type == 'Action' and Stage == details.Name) or (details.Type == 'Action' and Stage == details.ParentId and ResetStatus == details.Name)\r\n|summarize ResetDate = min(TimeGenerated), TotalCount = count(), SuccessCount = countif(ResetStatus == \"Success\"), FailureCount = countif(ResetStatus == \"Failed\"), CancelledCount = countif(ResetStatus == \"Cancelled\"),ThrottledCount = countif(ResetStatus == \"Throttled\"), BlockedCount = countif(ResetStatus == \"Blocked\"),InProgressCount = countif(Stage contains \"InProgress\") by User, ResetStatus, UserId, IPAddress, Stage, ResultReason, Result\r\n| order by ResetDate asc, User asc\r\n| project ResetDate, User, ResetStatus,TotalCount, SuccessCount,FailureCount,CancelledCount,InProgressCount,ThrottledCount, BlockedCount, UserId, IPAddress, Stage, ResultReason, Result\r\n| serialize Id = strcat(User, '/', ResetStatus)\r\n| join kind=inner\r\n(\r\n    caData\r\n)\r\non User\r\n| project User, UserId, IPAddress, Stage, ResultReason, Result, Id, ResetDate, Name = ResetStatus, Type = 'Action', Details = 'View Details', ['Reset Flow Count'] = TotalCount, ['Inprogress'] = InProgressCount,['Success'] = SuccessCount,['Failed'] = FailureCount,  ['Cancelled'] = CancelledCount,['Blocked'] = BlockedCount,['Throttled'] = ThrottledCount, ParentId = Id1\r\n| union (caData\r\n| project Id,Name = User, Type = 'User', ['Reset Flow Count'] = TotalCount, ParentId = '')\r\n|order by ResetDate asc\r\n\r\n\r\n",
        "size": 3,
        "title": "Reset Funnel per User",
        "noDataMessage": "Please select a user from the user list above to see the reset funnel details",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "Date",
        "exportToExcelOptions": "visible",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "User",
              "formatter": 5,
              "formatOptions": {
                "linkTarget": "GenericDetails",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            },
            {
              "columnMatch": "IPAddress",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Stage",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "ResultReason",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Result",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Id",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "ResetDate",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Name",
              "formatter": 0,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Type",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            },
            {
              "columnMatch": "Details",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "GenericDetails",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            },
            {
              "columnMatch": "Reset Flow Count",
              "formatter": 20,
              "formatOptions": {
                "palette": "turquoise",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Inprogress",
              "formatter": 4,
              "formatOptions": {
                "palette": "yellow",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Success",
              "formatter": 4,
              "formatOptions": {
                "palette": "green",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Failed",
              "formatter": 4,
              "formatOptions": {
                "palette": "redBright",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Cancelled",
              "formatter": 4,
              "formatOptions": {
                "palette": "redBright",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Blocked",
              "formatter": 4,
              "formatOptions": {
                "palette": "redBright",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Throttled",
              "formatter": 4,
              "formatOptions": {
                "palette": "redBright",
                "showIcon": true
              }
            },
            {
              "columnMatch": "ParentId",
              "formatter": 5,
              "formatOptions": {
                "showIcon": true
              }
            }
          ],
          "rowLimit": 100,
          "filter": true,
          "hierarchySettings": {
            "idColumn": "Id",
            "parentColumn": "ParentId",
            "treeType": 0,
            "expanderColumn": "Name",
            "expandTopLevel": true
          },
          "labelSettings": [
            {
              "columnId": "User",
              "label": "User"
            },
            {
              "columnId": "UserId",
              "label": "UserId"
            },
            {
              "columnId": "IPAddress",
              "label": "IPAddress"
            },
            {
              "columnId": "Stage",
              "label": "Stage"
            },
            {
              "columnId": "ResultReason",
              "label": "ResultReason"
            },
            {
              "columnId": "Result",
              "label": "Result"
            },
            {
              "columnId": "Id",
              "label": "Id"
            },
            {
              "columnId": "ResetDate",
              "label": "ResetDate"
            },
            {
              "columnId": "Name",
              "label": "Name"
            },
            {
              "columnId": "Type",
              "label": "Type"
            },
            {
              "columnId": "Details",
              "label": "Details"
            },
            {
              "columnId": "Reset Flow Count",
              "label": "Reset Flow Count"
            },
            {
              "columnId": "Inprogress",
              "label": "Inprogress"
            },
            {
              "columnId": "Success",
              "label": "Success"
            },
            {
              "columnId": "Failed",
              "label": "Failed"
            },
            {
              "columnId": "Cancelled",
              "label": "Cancelled"
            },
            {
              "columnId": "Blocked",
              "label": "Blocked"
            },
            {
              "columnId": "Throttled",
              "label": "Throttled"
            },
            {
              "columnId": "ParentId",
              "label": "ParentId"
            }
          ]
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "ResetStatus",
            "formatter": 1,
            "formatOptions": {
              "showIcon": true
            }
          },
          "centerContent": {
            "columnMatch": "dcount_User",
            "formatter": 1,
            "formatOptions": {
              "showIcon": true
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          },
          "nodeIdField": "ResetStatus",
          "sourceIdField": "ResetStatus",
          "targetIdField": "dcount_User",
          "nodeSize": null,
          "staticNodeSize": 100,
          "colorSettings": null,
          "hivesMargin": 5
        }
      },
      "conditionalVisibility": {
        "parameterName": "UserName",
        "comparison": "isNotEqualTo",
        "value": "null"
      },
      "name": "ResetDetails",
      "styleSettings": {
        "progressStyle": "squares"
      }
    }
  ],
  "styleSettings": {},
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
